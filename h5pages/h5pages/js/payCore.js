/** * 支付核心方法 1. 查询当前用户信息【包含用户财富】 2. 查询订单信息 3. 获取当前设备信息 4. * 发起订单请求【安智币、支付宝、银联、财付通、充值卡】 5. 回调sdk * 【充值安智币使用】 */var anzhi = window.anzhi;if (!anzhi) {  anzhi = {};}// 计数器var count = 0;// 短信支付套餐金额var sms_amt = 0;anzhi.pay = {  //TODO 转移  getUserInfo : function(sessionToken, callback) {    $.post(anzhi.getUserInfoAction, {      sesson_token : sessionToken    }, function(data) {      callback(data);    }, "json");  },  getOrder : function(orderId, callback) {    $.post(anzhi.queryOrderAction, {      orderId : orderId    }, function(data) {      callback(data);    });  },  /** * 显示提交订单后等待支付结果 * @param orderId * @param submitId */  showPayResult : function() {    anzhi.pay.getOrder(anzhi.order.orderId, function(result) {      var resp = $.parseJSON(result);      if (1 == resp.code || 0 == resp.code) {        clearInterval(anzhi.show);        hideLoader();        data.setData("OrderResult", result);        var hf = anzhi.payModel;        if (hf == 1) {          window.location.href = anzhi.orderPayResultJsp;        } else if (hf == 2) {          window.location.href = anzhi.orderPayNewResultJsp;        }      } else {        if (2 == resp.code) {          //设置计数器 提示超过2次则关闭          count++;          if (count > 3) {            clearInterval(anzhi.show);            hideLoader();            $("#submitBut").html("查询订单");          }        } else {          hideLoader();          clearInterval(anzhi.show);        }      }    });  }};/** * 支付核心模块 接口调用 */var orderTimes = 0;  // 短信的总的次数var errTimes = 0;  // 回调失败次数var returnTimes = 0;  // 回调失败次数anzhi.order = {  submit : function(payType, amt, card, sms) {    var data = anzhi.pay.Data.Method;    var action = anzhi.payAction;        // 设置支付请求地址    var order = data.getData("Order");    if (anzhi.orderType["pay"] == order.orderType) {         // 设置支付金额      amt = order.orderAmt;    }    order.orderAmt = amt;    var deviceJson = data.getJson("Device");    var accountJson = data.getJson("Account");    var orderJson = $.toJSON(order);    var myHead = data.getJson("HeadJson");    $.post( action, {      account : accountJson,      payType : payType,      card : card,      sms : sms,      device : deviceJson,      order : orderJson,      headJson : myHead    }, function(resp) {      if (typeof resp == "string")        eval("resp=" + resp);      if (1 == resp.code) {        anzhi.order.orderId = resp.orderId;        if (resp.orderId != null && resp.orderId != '') {          order.orderId = anzhi.order.orderId;          orderJson = $.toJSON(order);          data.setData("Order", orderJson);        }        // 0等待支付结果 1 重定向 2 调控件        if (0 == resp.returnType) {          if (resp.payType == anzhi.payTypes.SMS_PAY.value) {            // 设定支付金额为短信支付套餐金额            var smsObj = $.parseJSON(sms);            sms_amt = smsObj.smsAmount;            order.payType = resp.payType;            order.smsAmt = sms_amt;            orderJson = $.toJSON(order);            data.setData("Order", orderJson);            hideLoader();            $("#submitBut").hide();            var proNumTemp = resp.proNum;            if (proNumTemp == "SF_LT" || proNumTemp == "SF_DX") {              showLoader();              var objsfOld = eval("(" + resp.msg + ")");              orderTimes = 1;              returnTimes = 1;              var content = objsfOld.message + objsfOld.orderId;              Android.sendMessage(objsfOld.channelNumber, content, "showSendResult", objsfOld.type);            } else if (proNumTemp == "SF_X_LT" || proNumTemp == "SF_X_DX") {              showLoader();              var objsf = eval("(" + resp.msg + ")");              orderTimes = objsf.length;              returnTimes = orderTimes;              for (var i = 0; i < objsf.length; i++) {                var obj = objsf[i];                var content = obj.message + obj.orderId;                Android.sendMessage(obj.channelNumber, content, "showSendResult", obj.type);              }            } else if (proNumTemp == "LD_YD") {              showLoader();              var objld = eval("(" + resp.msg + ")");              orderTimes = parseInt(objld.length) + parseInt(objld.length);              returnTimes = parseInt(orderTimes);              for (var i = 0; i < objld.length; i++) {                var obj = objld[i];                var content = obj.message + obj.orderId;                Android.sendMessage(obj.channelNumber, content, "showSendResult", obj.type);                Android.sendMessage(obj.channelNumber, content, "showSendResult", obj.type);              }            } else if (proNumTemp == "LTJT_LT") {              showLoader();              var objltjt = eval("(" + resp.msg + ")");              orderTimes = objltjt.length;              returnTimes = orderTimes;              for (var i = 0; i < objltjt.length; i++) {                var obj = objltjt[i];                var content = obj.message + obj.orderId;                Android.sendMessage(obj.channelNumber, content, "showSendResult", obj.type);              }            }            return;          } else if (resp.payType == anzhi.payTypes.CARD.value) {            if (order.orderType == 1) {              // Android.orderResult(order.orderType,order.orderId, order.orderAmt,"2", '支付中','');            }          } else if (resp.payType == anzhi.payTypes.SMS_PAY_LD.value) {            var obj = $.parseJSON(resp.msg);            // 设定支付金额为短信支付套餐金额            var smsObj = $.parseJSON(sms);            sms_amt = smsObj.smsAmount;            order.payType = resp.payType;            order.smsAmt = sms_amt;            orderJson = $.toJSON(order);            data.setData("Order", orderJson);            hideLoader();            $("#submitBut").hide();            Android.sendMessage(obj.channelNumber, obj.message + resp.orderId, "showLDResult", obj.type, obj.channelNumber, sms_amt, "通信账户支付,话费支付");            return;          }          anzhi.show = setInterval(anzhi.pay.showPayResult, 5000);        }        if (1 == resp.returnType) {          if (resp.msg == "wap.tengpay.com") {            alert("网关异常，请从新支付");            return;          }          window.location.href = resp.msg;        }        if (2 == resp.returnType) {          if (resp.payType != null && (resp.payType == anzhi.payTypes.ZFB_SDK_NEW.value || resp.payType == anzhi.payTypes.ZFB_SDK.value            || resp.payType == anzhi.payTypes.UNION_PAY_NEW.value || resp.payType == anzhi.payTypes.WXPAY.value)) {            Android.pay(order.orderType, resp.msg, resp.price, resp.orderId, resp.sign, payType, "showAliNSDKResult");          } else {            Android.pay(order.orderType, resp.msg, resp.price, resp.orderId, resp.sign, payType);          }        hideLoader();      }    } else { // code <> 1 (0) 支付失败      if (3 == resp.returnType) {        var msg = resp.msg;        var isGt33 = resp.orderId;        if (resp.msg == '51040') {          msg = '您登录的账号已解绑,请重新登录';        } else if (resp.msg == '51025') {          msg = '登录信息已失效，请重新登录';        }        hideLoader();        if ($('.dialog_cmt'))          $('.dialog_cmt').hide();        if ($('#dialog'))          $('#dialog').hide();        if ('Y' == isGt33) {          Android.resLogin(msg);        } else {          alert(msg);        }        return;      }      hideLoader();      if ($('.dialog_cmt'))        $('.dialog_cmt').hide();      if ($('#dialog'))        $('#dialog').hide();      alert(resp.msg);      $("#submitBut").show();    }  });},// 定义orderId 初始化为null  orderId : null};// 联动短信回调结果0失败，1成功function showLDResult(datas) {  var data = anzhi.pay.Data.Method;  // 获取支付订单信息  var order = data.getData("Order");  // 短信发送成功  if (datas == "1") {    var account = data.getData("Account");    var strs = "充值";    if (order.orderType == 1) {      Android.orderResult(order.orderType, order.orderId, order.orderAmt,"2", '支付成功', '');    }    var name = account != null && account.loginName != null && account.loginName != undefined ? account.loginName : "";    order.recAccount = name;    var temp = $.toJSON(order);    data.setData("OrderResult", temp);    var hf = anzhi.payModel;    if (hf == 1) {      window.location.href = anzhi.orderPayResultJsp;    } else if (hf == 2) {      window.location.href = anzhi.orderPayNewResultJsp;    }  } else {    alert("提示用户：充值失败，请确认手机话费是否充足,运营商选择是否正确后再重试。");    // 十秒后允许提交订单    var timer;    var times = 10;    if (anzhi.orderType["pay"] == order.orderType) {      strs = "支付";    }    timer = setInterval(function() {      if (times <= 0) {        $("#submitBut").show();        window.clearInterval(timer);        $('#msgId').html('');        return;      }      $('#msgId').html(times + "秒后重新" + strs).css({        padding : "12px",        font : "14px/26px Microsoft YaHei,'微软雅黑'",        display : "block",        color : "red"      });      times--;      return;    }, 1000);    return;  }};// 短信支付结果处理0失败，1成功function showSendResult(datas) {  returnTimes = parseInt(returnTimes) - parseInt(1);  var data = anzhi.pay.Data.Method;  var order = data.getData("Order");  var account = data.getData("Account");  var strs = "充值";  // 短信发送成功  if (datas == "1") {    orderTimes = parseInt(orderTimes) - parseInt(1);    if (orderTimes != 0) {      return;    }    hidenLoader();    if (order.orderType == 1) {      Android.orderResult(order.orderType, order.orderId, order.orderAmt,"2", '支付中', '');    }    var name = account != null && account.loginName != null && account.loginName != undefined ? account.loginName : "";    order.recAccount = name;    var temp = $.toJSON(order);    data.setData("OrderResult", temp);    var hf = anzhi.payModel;    if (hf == 1) {      window.location.href = anzhi.orderPayResultJsp;    } else if (hf == 2) {      window.location.href = anzhi.orderPayNewResultJsp;    }  } else {    if (returnTimes != 0) {      return;    }    hidenLoader();    // 十秒后允许提交订单    var timer;    var times = 10;    if (anzhi.orderType["pay"] == order.orderType) {      strs = "支付";    }    alert("短信发送失败，请确认手机话费是否充足,运营商选择是否正确后再重试");    timer = setInterval(function() {      if (times <= 0) {        $("#submitBut").show();        window.clearInterval(timer);        $('#msgId').html('');        return;      }      $('#msgId').html(times + "秒后重新" + strs).css({        padding : "12px",        font : "14px/26px Microsoft YaHei,'微软雅黑'",        display : "block",        color : "red"      });      times--;      return;    }, 1000);    return;  }};// 支付宝新版SDKfunction showAliNSDKResult(datas) {  var data = anzhi.pay.Data.Method;  // 获取支付订单信息  var order = data.getData("Order");  if (datas == "1") {    var account = data.getData("Account");    // TODO 查看回调数据    if (order.orderType == 1) {      Android.orderResult(order.orderType, order.orderId, order.orderAmt,"1", '支付成功', '');    }    var name = account != null && account.loginName != null && account.loginName != undefined ? account.loginName : "";    order.recAccount = name;    // 表示成功    order.code = 1;    order.price = order.orderAmt;    var temp = $.toJSON(order);    data.setData("OrderResult", temp);    window.location.href = anzhi.orderPayNewResultJsp;  } else {    alert("支付失败，请确认后再试");    // 十秒后允许提交订单    return;  }};// 显示加载器function showLoader() {  // 显示加载器  $(".myloading").show();  $("#loading").show();}function hidenLoader() {  // 显示加载器  if ($(".myloading"))    $(".myloading").hide();  if ($("#loading"))    $("#loading").hide();}// 隐藏加载器.for jQuery Mobile 1.2.0function hideLoader() {  try {    hidenLoader();    $("#submitBut").show();    if (typeof loadingClose == "function") {      var c = loadingClose();      if (c)        return;    }  } catch (e) {    alert(e);  }	// 隐藏加载器	// $.mobile.loading('hide');}// 显示function sWaiter() {  // 显示加载器.for jQuery Mobile 1.2.0  $.mobile.loading('show', {    text : '请稍等...', // 加载器中显示的文字    textVisible : true, // 是否显示文字    theme : 'a', // 加载器主题样式a-e    textonly : false, // 是否只显示文字    html : $("#paying").html()   // 要显示的html内容，如图片等  });}// 替换特殊字符为默认值10function isChn(str) {  var reg = /^[u4E00-u9FA5]+$/;  if (!reg.test(str)) {    $("#diyAmt").val("10");    return false;  }  return true;}